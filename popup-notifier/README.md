〇ブラウザへのポップアップ通知用デーモン

 PBXからの着信をブラウザに通知するためのデーモンです。Goで記述されています。Goの開発環境を入れておいてください。
 Debian(bookworm)上のGo 1.25.4 で動作を確認しています。

1. コンパイル

 go build . でコンパイルできます。
 
2. インストール

 /usr/local/bin/に popup-notifier をコピーしておきます。
 /usr/local/etc/に popup-notifier.conf を作成します。サンプルファイルを添付していますのでこれをコピーして修正してもかまいません。

3. 設定

サンプル設定ファイルは次のようになっています。

```
# listenするポート番号。デフォルトは8080。
PORT=8989

# triggerを使用する際のtoken
SECRET_TOKEN=mytoken

#ACL設定。デフォルト挙動は全てdenyなので注意。
#ACLを設定しないとどこからも接続できない。

# /api/trigger の許可リスト
# 複数のIP/CIDRをカンマ区切りで
# 例:ローカルホストのみ許可
TRIGGER_ALLOW=127.0.0.1

# /crmws (WebSocket) の許可リスト
# 例: ローカルホストと社内LAN全体を許可
CRMWS_ALLOW=127.0.0.1,192.168.0.0/16
```

 この popup-notifer には2つのエンドポイントがあります。
 
 /api/trigger - PBXから着信を通知するためのトリガーポイントです。

 /crmws       - ブラウザからWebSocketで接続するポイントです。

 ブラウザからの接続はJavaScript等でWebSocket接続します。通知はブロードキャスト(接続しているブラウザ全て)に対して行われ、JSON形式でphoneとextenが通知されます。phoneは着信した番号、extenは応答した内線番号です。ただし、これら情報はPBXから取得する必要があるので、トリガー時に指定します。先述のようにブロードキャスト通知なので大規模なCRMには向きませんので注意してください。
 いずれのエンドポイントもACLを設けています。ACLが設定されていない場合には全拒否です。このデーモンとPBXを同じサーバで動作させている場合、トリガーは127.0.0.1にだけ許可すれば良いのですが、WebSocketはネットワーク上から接続してきますから、使用するネットワークアドレスを設定してください。
 SECRET_TOKENはトリガー時に使用するトークンです。


4. 起動/終了

 systemdのサービス設定ファイルを添付していますので、systemdに登録してください。systemdでの管理は一般的なものと同じです。

5. トリガー方法

 ブラウザに通知を送るには"トリガー"します。トリガーはcurl等で行うことができます。

 curl -X POST "http://127.0.0.1:8989/api/trigger?phone=0312345678&exten=201&token=mytoken" -m 1

 phone= - 着信した番号を指定します。CRMで検索のキーに使うものを指定します。

 exten= - 着信に応答した内線番号を指定します。指定がない場合には"all"が通知されます。

 token= - 設定ファイルで指定したトークンとあわせます。

 トリガーを受け取るとデーモンは接続している全ブラウザに対して着信をブロードキャスト通知します。
 受け取ったブラウザでの処理方法は自由ですが、たとえばexten=allで受け取った場合には、全ブラウザでポップアップ、exen=201のように特定内線が指定されている場合には、特定のブラウザだけポップアップのように使い分けることができます。

6. Asteriskでの使用

 Asteriskで使用する場合、着信時に全ブラウザに通知したい場合には着信経路上に以下のような記述を入れます。

 exten => s,n,System(curl -X POST "http://localhost:8989/api/trigger?phone=${CALLERID(num)}&exten=all&token=mytoken" -m 1)

 応答した内線での通知を送りたい場合にはプレ・ブリッジハンドラを使ってください。Dial時のオプション'U'で指定するサブルーチンです。


サンプルのJavaScriptをpopup-sample.jsで添付しています。別なCRM等でポップアップ実行を行いたい場合にはこれを参考にしてください。
